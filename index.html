<!DOCTYPE html>
<html lang="bg">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Kelly Calculator Pro</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; }
        .pulse-animation { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: .5; } }
    </style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
    
    <div id="loadingScreen" class="fixed inset-0 bg-blue-600 flex items-center justify-center z-50">
        <div class="text-center text-white">
            <div class="text-6xl mb-4">‚öΩ</div>
            <h1 class="text-3xl font-bold mb-2">Kelly Calculator Pro</h1>
            <div class="pulse-animation text-xl">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
        </div>
    </div>
    
    <div id="authScreen" class="hidden min-h-screen flex items-center justify-center p-4">
        <div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
            <h1 class="text-3xl font-bold text-center mb-2 text-blue-600">‚öΩ Kelly Calculator Pro</h1>
            <p class="text-center text-gray-500 text-sm mb-6">–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω –∑–∞–ª–∞–≥–∞—Ç–µ–ª–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä</p>
            
            <div id="loginForm">
                <h2 class="text-xl font-semibold mb-4">–í—Ö–æ–¥</h2>
                <input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
                <input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
                <button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 mb-3">–í–ª–µ–∑</button>
                <p class="text-center text-sm text-gray-600">
                    –ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToRegister" class="text-blue-600 font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button>
                </p>
                <hr class="my-4">
                <button id="showAdminBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700">üëë Admin –í—Ö–æ–¥</button>
            </div>
            
            <div id="registerForm" class="hidden">
                <h2 class="text-xl font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
                <input type="text" id="registerUsername" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ" class="w-full p-3 border-2 rounded-lg mb-3">
                <input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
                <input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
                <button id="registerBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 mb-3">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button>
                <p class="text-center text-sm text-gray-600">
                    –ò–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToLogin" class="text-blue-600 font-semibold">–í–ª–µ–∑</button>
                </p>
            </div>
            
            <div id="adminLoginForm" class="hidden">
                <h2 class="text-xl font-semibold mb-4">üëë Admin –í—Ö–æ–¥</h2>
                <input type="password" id="adminPassword" placeholder="Admin –ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
                <button id="adminLoginBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 mb-3">–í–ª–µ–∑ –∫–∞—Ç–æ Admin</button>
                <button id="hideAdminBtn" class="w-full bg-gray-400 text-white p-2 rounded-lg">–ù–∞–∑–∞–¥</button>
            </div>
            
            <div id="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
        </div>
    </div>
    
    <div id="mainApp" class="hidden p-4 max-w-7xl mx-auto">
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <div class="flex justify-between items-center">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">‚öΩ Kelly Calculator Pro</h1>
                    <p class="text-sm text-gray-600" id="userInfo"></p>
                </div>
                <button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">–ò–∑—Ö–æ–¥</button>
            </div>
        </div>
        <div id="calculatorContent"></div>
    </div>

<script>
const TELEGRAM_WEBHOOK_URL = 'https://script.google.com/macros/s/AKfycbzBkkFvbxo7_eKpfBzdg5HTb8ecIY_MYlQhIvyT5Vo_FmY87ah8iEt6BT693TJ_8fZFpw/exec';
const ADMIN_PASSWORD = "Bold_9000";

let currentUser = null;
let isAdmin = false;
let auth, db;
let firebaseReady = false;

let state = {
    initialBank: 1000,
    currentBank: 1000,
    stakes: [],
    kellyType: 'half',
    market: 'home',
    homeTeam: '',
    awayTeam: '',
    odds: '',
    winProb: ''
};

const firebaseConfig = {
    apiKey: "AIzaSyD_cE6Ek3L_l7wHRkrrmswlksUb1fLEWLA",
    authDomain: "kelly-calculator-fbf1a.firebaseapp.com",
    projectId: "kelly-calculator-fbf1a",
    storageBucket: "kelly-calculator-fbf1a.firebasestorage.app",
    messagingSenderId: "707784565895",
    appId: "1:707784565895:web:e27104dc0ed8d8996b0422",
    measurementId: "G-196ZJ43NT2"
};

function initializeFirebase() {
    return new Promise((resolve, reject) => {
        let attempts = 0;
        const maxAttempts = 50;
        
        const checkFirebase = setInterval(() => {
            attempts++;
            
            if (typeof firebase !== 'undefined') {
                clearInterval(checkFirebase);
                
                try {
                    firebase.initializeApp(firebaseConfig);
                    auth = firebase.auth();
                    db = firebase.firestore();
                    firebaseReady = true;
                    console.log('‚úÖ Firebase OK');
                    resolve();
                } catch (error) {
                    console.error('‚ùå Firebase Error:', error);
                    reject(error);
                }
            } else if (attempts >= maxAttempts) {
                clearInterval(checkFirebase);
                reject(new Error('Firebase timeout'));
            }
        }, 100);
    });
}

function showError(message) {
    const errorDiv = document.getElementById('authError');
    errorDiv.textContent = message;
    errorDiv.classList.remove('hidden');
    setTimeout(() => errorDiv.classList.add('hidden'), 5000);
}

function toggleAuth() {
    document.getElementById('loginForm').classList.toggle('hidden');
    document.getElementById('registerForm').classList.toggle('hidden');
}

function showAdminLogin() {
    document.getElementById('loginForm').classList.add('hidden');
    document.getElementById('adminLoginForm').classList.remove('hidden');
}

function hideAdminLogin() {
    document.getElementById('adminLoginForm').classList.add('hidden');
    document.getElementById('loginForm').classList.remove('hidden');
}

async function register() {
    if (!firebaseReady) {
        showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');
        return;
    }
    
    const username = document.getElementById('registerUsername').value;
    const email = document.getElementById('registerEmail').value;
    const password = document.getElementById('registerPassword').value;
    
    if (!username || !email || !password) {
        showError('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');
        return;
    }
    
    try {
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        await db.collection('users').doc(userCredential.user.uid).set({
            username: username,
            email: email,
            initialBank: 1000,
            createdAt: firebase.firestore.FieldValue.serverTimestamp()
        });
        showError('‚úÖ –£—Å–ø–µ—à–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!');
    } catch (error) {
        showError('–ì—Ä–µ—à–∫–∞: ' + error.message);
    }
}

async function login() {
    if (!firebaseReady) {
        showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');
        return;
    }
    
    const email = document.getElementById('loginEmail').value;
    const password = document.getElementById('loginPassword').value;
    
    if (!email || !password) {
        showError('–í—ä–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª–∞!');
        return;
    }
    
    try {
        await auth.signInWithEmailAndPassword(email, password);
    } catch (error) {
        showError('–ì—Ä–µ—à–∫–∞: ' + error.message);
    }
}

function adminLogin() {
    const password = document.getElementById('adminPassword').value;
    if (password === ADMIN_PASSWORD) {
        isAdmin = true;
        document.getElementById('authScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        loadAdminPanel();
    } else {
        showError('–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!');
    }
}

function logout() {
    if (isAdmin) {
        location.reload();
    } else {
        auth.signOut();
    }
}

function calculateStakeAmount(odds, winProb, kellyType, bank) {
    const p = parseFloat(String(winProb).replace(',', '.')) / 100;
    const o = parseFloat(String(odds).replace(',', '.'));
    
    if (!p || !o || p <= 0 || p >= 1 || o <= 1) return 0;
    
    const q = 1 - p;
    const kellyFraction = (p * o - q) / o;
    
    let multiplier = kellyType === 'half' ? 0.5 : kellyType === 'quarter' ? 0.25 : 1;
    return Math.max(0, bank * kellyFraction * multiplier);
}

function calculateEdge(odds, winProb) {
    const p = parseFloat(String(winProb).replace(',', '.')) / 100;
    const o = parseFloat(String(odds).replace(',', '.'));
    
    if (!p || !o || p <= 0 || p >= 1 || o <= 1) return null;
    
    const ev = (p * o) - 1;
    return {
        hasValue: ev > 0,
        edgePercent: ev * 100
    };
}

function getMarketLabel(market) {
    const labels = {
        'home': 'üè† Home',
        'away': '‚úàÔ∏è Away',
        'over2.5': '‚öΩ Over 2.5',
        'under2.5': '‚öΩ Under 2.5'
    };
    return labels[market] || market;
}

async function addStake() {
    const stakeAmount = calculateStakeAmount(state.odds, state.winProb, state.kellyType, state.currentBank);
    
    if (!state.homeTeam || !state.awayTeam) {
        alert('–í—ä–≤–µ–¥–∏ –¥–æ–º–∞–∫–∏–Ω –∏ –≥–æ—Å—Ç!');
        return;
    }
    
    if (stakeAmount <= 0) {
        alert('–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏!');
        return;
    }

    const newStake = {
        userId: currentUser.uid,
        number: state.stakes.length + 1,
        homeTeam: state.homeTeam,
        awayTeam: state.awayTeam,
        market: state.market,
        kellyType: state.kellyType,
        odds: parseFloat(String(state.odds).replace(',', '.')),
        winProb: parseFloat(String(state.winProb).replace(',', '.')),
        stakeAmount: stakeAmount,
        potentialWin: stakeAmount * parseFloat(String(state.odds).replace(',', '.')),
        potentialProfit: (stakeAmount * parseFloat(String(state.odds).replace(',', '.'))) - stakeAmount,
        result: 'pending',
        sentToTelegram: false,
        timestamp: firebase.firestore.FieldValue.serverTimestamp()
    };

    await db.collection('stakes').add(newStake);
    state.currentBank -= stakeAmount;
    state.homeTeam = '';
    state.awayTeam = '';
    state.odds = '';
    state.winProb = '';
    await loadUserCalculator();
}

async function markResult(stakeId, result) {
    const stakeDoc = await db.collection('stakes').doc(stakeId).get();
    const stake = stakeDoc.data();
    
    await db.collection('stakes').doc(stakeId).update({ result: result });
    
    if (result === 'win') {
        state.currentBank += stake.potentialWin || 0;
    } else if (result === 'push') {
        state.currentBank += stake.stakeAmount || 0;
    }
    
    await loadUserCalculator();
}

async function loadUserCalculator() {
    try {
        const stakesSnapshot = await db.collection('stakes')
            .where('userId', '==', currentUser.uid)
            .get();
        
        state.stakes = [];
        let tempBank = state.initialBank;
        
        const stakesArray = [];
        stakesSnapshot.forEach(doc => {
            const data = doc.data();
            stakesArray.push({ 
                id: doc.id, 
                ...data,
                timestamp: data.timestamp?.toDate ? data.timestamp.toDate() : new Date()
            });
        });
        
        stakesArray.sort((a, b) => b.timestamp - a.timestamp);
        state.stakes = stakesArray;
        
        stakesArray.forEach(stake => {
            tempBank -= stake.stakeAmount || 0;
            if (stake.result === 'win') tempBank += stake.potentialWin || 0;
            else if (stake.result === 'push') tempBank += stake.stakeAmount || 0;
        });
        
        state.currentBank = tempBank;
        renderCalculator();
    } catch (error) {
        console.error('Error:', error);
    }
}

async function loadAdminPanel() {
    document.getElementById('userInfo').textContent = 'üëë Admin Mode';
    document.getElementById('calculatorContent').innerHTML = '<div class="bg-white p-6 rounded-xl"><h2 class="text-2xl font-bold">Admin Panel</h2><p class="mt-4">Admin —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç...</p></div>';
}

function renderCalculator() {
    const pendingStakes = state.stakes.filter(s => s && s.result === 'pending');
    const completedStakes = state.stakes.filter(s => s && s.result !== 'pending');

    document.getElementById('calculatorContent').innerHTML = `
        <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
            <h2 class="text-xl font-bold mb-4">–ë–∞–Ω–∫–∞: ${state.currentBank.toFixed(2)} –ª–≤</h2>
            
            <div class="grid grid-cols-2 gap-4 mb-4">
                <input type="text" id="homeTeamInput" placeholder="–î–æ–º–∞–∫–∏–Ω" class="p-3 border-2 rounded-lg">
                <input type="text" id="awayTeamInput" placeholder="–ì–æ—Å—Ç" class="p-3 border-2 rounded-lg">
            </div>
            
            <div class="grid grid-cols-4 gap-4 mb-4">
                <select id="marketSelect" class="p-3 border-2 rounded-lg">
                    <option value="home">üè† Home</option>
                    <option value="away">‚úàÔ∏è Away</option>
                    <option value="over2.5">‚öΩ Over 2.5</option>
                </select>
                <select id="kellyTypeSelect" class="p-3 border-2 rounded-lg">
                    <option value="half">Half Kelly</option>
                    <option value="quarter">Quarter Kelly</option>
                </select>
                <input type="number" id="oddsInput" placeholder="–ö–æ–µ—Ñ." class="p-3 border-2 rounded-lg">
                <input type="number" id="winProbInput" placeholder="%" class="p-3 border-2 rounded-lg">
            </div>
            
            <button id="addStakeBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold">‚ûï –î–æ–±–∞–≤–∏</button>
        </div>

        ${pendingStakes.length > 0 ? `
            <div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
                <h2 class="text-xl font-bold mb-4">‚è≥ –ê–∫—Ç–∏–≤–Ω–∏ (${pendingStakes.length})</h2>
                ${pendingStakes.map(s => `
                    <div class="border-b p-3">
                        <p class="font-bold">${s.homeTeam} vs ${s.awayTeam}</p>
                        <p>–ó–∞–ª–æ–≥: ${s.stakeAmount.toFixed(2)} –ª–≤</p>
                        <button onclick="window.markResult('${s.id}', 'win')" class="bg-green-500 text-white px-3 py-1 rounded mr-2">Win</button>
                        <button onclick="window.markResult('${s.id}', 'lose')" class="bg-red-500 text-white px-3 py-1 rounded">Lose</button>
                    </div>
                `).join('')}
            </div>
        ` : ''}
    `;
    
    const homeInput = document.getElementById('homeTeamInput');
    const awayInput = document.getElementById('awayTeamInput');
    const oddsInput = document.getElementById('oddsInput');
    const probInput = document.getElementById('winProbInput');
    const addBtn = document.getElementById('addStakeBtn');
    
    if (homeInput) homeInput.addEventListener('input', e => state.homeTeam = e.target.value);
    if (awayInput) awayInput.addEventListener('input', e => state.awayTeam = e.target.value);
    if (oddsInput) oddsInput.addEventListener('input', e => state.odds = e.target.value);
    if (probInput) probInput.addEventListener('input', e => state.winProb = e.target.value);
    if (addBtn) addBtn.addEventListener('click', addStake);
}

window.markResult = markResult;

document.addEventListener('DOMContentLoaded', () => {
    document.getElementById('loginBtn')?.addEventListener('click', login);
    document.getElementById('registerBtn')?.addEventListener('click', register);
    document.getElementById('adminLoginBtn')?.addEventListener('click', adminLogin);
    document.getElementById('logoutBtn')?.addEventListener('click', logout);
    document.getElementById('toggleToRegister')?.addEventListener('click', toggleAuth);
    document.getElementById('toggleToLogin')?.addEventListener('click', toggleAuth);
    document.getElementById('showAdminBtn')?.addEventListener('click', showAdminLogin);
    document.getElementById('hideAdminBtn')?.addEventListener('click', hideAdminLogin);
});

initializeFirebase().then(() => {
    document.getElementById('loadingScreen').style.display = 'none';
    
    auth.onAuthStateChanged(async (user) => {
        if (user && !isAdmin) {
            currentUser = user;
            const userDoc = await db.collection('users').doc(user.uid).get();
            const userData = userDoc.data();
            
            state.initialBank = userData.initialBank || 1000;
            
            document.getElementById('authScreen').classList.add('hidden');
            document.getElementById('mainApp').classList.remove('hidden');
            document.getElementById('userInfo').textContent = `–ó–¥—Ä–∞–≤–µ–π, ${userData.username}!`;
            
            await loadUserCalculator();
        } else if (!isAdmin) {
            document.getElementById('authScreen').classList.remove('hidden');
            document.getElementById('mainApp').classList.add('hidden');
        }
    });
}).catch(error => {
    alert('Firebase Error: ' + error.message);
});
</script>
</body>
</html>
