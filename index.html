<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kelly Calculator Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
.pulse-animation{animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
</style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
<div id="loadingScreen" class="fixed inset-0 bg-blue-600 flex items-center justify-center z-50">
<div class="text-center text-white">
<div class="text-6xl mb-4">‚öΩ</div>
<h1 class="text-3xl font-bold mb-2">Kelly Calculator Pro</h1>
<div class="pulse-animation text-xl">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
</div>
</div>
<div id="authScreen" class="hidden min-h-screen flex items-center justify-center p-4">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
<h1 class="text-3xl font-bold text-center mb-2 text-blue-600">‚öΩ Kelly Calculator Pro</h1>
<p class="text-center text-gray-500 text-sm mb-6">–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω –∑–∞–ª–∞–≥–∞—Ç–µ–ª–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä</p>
<div id="loginForm">
<h2 class="text-xl font-semibold mb-4">–í—Ö–æ–¥</h2>
<input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 mb-3">–í–ª–µ–∑</button>
<p class="text-center text-sm text-gray-600">–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToRegisterBtn" class="text-blue-600 font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button></p>
<hr class="my-4">
<button id="showAdminBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700">üëë Admin –í—Ö–æ–¥</button>
</div>
<div id="registerForm" class="hidden">
<h2 class="text-xl font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<input type="text" id="registerUsername" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="registerBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 mb-3">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button>
<p class="text-center text-sm text-gray-600">–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToLoginBtn" class="text-blue-600 font-semibold">–í–ª–µ–∑</button></p>
</div>
<div id="adminLoginForm" class="hidden">
<h2 class="text-xl font-semibold mb-4">üëë Admin –í—Ö–æ–¥</h2>
<input type="password" id="adminPassword" placeholder="Admin –ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="adminLoginBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 mb-3">–í–ª–µ–∑ –∫–∞—Ç–æ Admin</button>
<button id="hideAdminBtn" class="w-full bg-gray-400 text-white p-2 rounded-lg">–ù–∞–∑–∞–¥</button>
</div>
<div id="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
</div>
</div>
<div id="mainApp" class="hidden p-4 max-w-7xl mx-auto">
<div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
<div class="flex justify-between items-center">
<div>
<h1 class="text-3xl font-bold text-gray-800">‚öΩ Kelly Calculator Pro</h1>
<p class="text-sm text-gray-600" id="userInfo"></p>
</div>
<button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">–ò–∑—Ö–æ–¥</button>
</div>
</div>
<div id="calculatorContent"></div>
</div>
<script>
const TELEGRAM_WEBHOOK_URL='https://script.google.com/macros/s/AKfycbzBkkFvbxo7_eKpfBzdg5HTb8ecIY_MYlQhIvyT5Vo_FmY87ah8iEt6BT693TJ_8fZFpw/exec';
const ADMIN_PASSWORD="Bold_9000";
let currentUser=null;
let isAdmin=false;
let auth,db;
let firebaseReady=false;
let state={initialBank:1000,currentBank:1000,stakes:[],kellyType:'half',market:'home',homeTeam:'',awayTeam:'',odds:'',winProb:''};
const firebaseConfig={apiKey:"AIzaSyD_cE6Ek3L_l7wHRkrrmswlksUb1fLEWLA",authDomain:"kelly-calculator-fbf1a.firebaseapp.com",projectId:"kelly-calculator-fbf1a",storageBucket:"kelly-calculator-fbf1a.firebasestorage.app",messagingSenderId:"707784565895",appId:"1:707784565895:web:e27104dc0ed8d8996b0422",measurementId:"G-196ZJ43NT2"};
function initializeFirebase(){return new Promise((resolve,reject)=>{let attempts=0;const maxAttempts=50;const checkFirebase=setInterval(()=>{attempts++;if(typeof firebase!=='undefined'){clearInterval(checkFirebase);try{firebase.initializeApp(firebaseConfig);auth=firebase.auth();db=firebase.firestore();firebaseReady=true;console.log('‚úÖ Firebase OK');resolve();}catch(error){console.error('‚ùå Firebase Error:',error);reject(error);}}else if(attempts>=maxAttempts){clearInterval(checkFirebase);reject(new Error('Firebase timeout'));}},100);});}
function showError(message){const errorDiv=document.getElementById('authError');errorDiv.textContent=message;errorDiv.classList.remove('hidden');setTimeout(()=>errorDiv.classList.add('hidden'),5000);}
function toggleAuth(){document.getElementById('loginForm').classList.toggle('hidden');document.getElementById('registerForm').classList.toggle('hidden');}
function showAdminLogin(){document.getElementById('loginForm').classList.add('hidden');document.getElementById('adminLoginForm').classList.remove('hidden');}
function hideAdminLogin(){document.getElementById('adminLoginForm').classList.add('hidden');document.getElementById('loginForm').classList.remove('hidden');}
async function register(){if(!firebaseReady){showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');return;}const username=document.getElementById('registerUsername').value;const email=document.getElementById('registerEmail').value;const password=document.getElementById('registerPassword').value;if(!username||!email||!password){showError('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{const userCredential=await auth.createUserWithEmailAndPassword(email,password);await db.collection('users').doc(userCredential.user.uid).set({username:username,email:email,initialBank:1000,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showError('‚úÖ –£—Å–ø–µ—à–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!');}catch(error){showError('–ì—Ä–µ—à–∫–∞: '+error.message);}}
async function login(){if(!firebaseReady){showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');return;}const email=document.getElementById('loginEmail').value;const password=document.getElementById('loginPassword').value;if(!email||!password){showError('–í—ä–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª–∞!');return;}try{await auth.signInWithEmailAndPassword(email,password);}catch(error){showError('–ì—Ä–µ—à–∫–∞: '+error.message);}}
function adminLogin(){const password=document.getElementById('adminPassword').value;if(password===ADMIN_PASSWORD){isAdmin=true;document.getElementById('authScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');document.getElementById('loadingScreen').style.display='none';loadAdminPanel();}else{showError('–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!');}}
function logout(){if(isAdmin){location.reload();}else{auth.signOut();}}
function calculateStakeAmount(odds,winProb,kellyType,bank){const p=parseFloat(String(winProb).replace(',','.'))/100;const o=parseFloat(String(odds).replace(',','.'));if(!p||!o||p<=0||p>=1||o<=1)return 0;const q=1-p;const kellyFraction=(p*o-q)/o;let multiplier=kellyType==='half'?0.5:kellyType==='quarter'?0.25:1;return Math.max(0,bank*kellyFraction*multiplier);}
function calculateEdge(odds,winProb){const p=parseFloat(String(winProb).replace(',','.'))/100;const o=parseFloat(String(odds).replace(',','.'));if(!p||!o||p<=0||p>=1||o<=1)return null;const ev=(p*o)-1;return{hasValue:ev>0,edgePercent:ev*100};}
function calculateYield(profit,totalStaked){if(totalStaked===0)return 0;return(profit/totalStaked)*100;}
function calculateROI(currentBank,initialBank){if(initialBank===0)return 0;return((currentBank-initialBank)/initialBank)*100;}
function getMarketLabel(market){const labels={'home':'üè† Home','away':'‚úàÔ∏è Away','over0.5home':'‚öΩ O0.5 Home','over0.5away':'‚öΩ O0.5 Away','over1.5':'‚öΩ Over 1.5','under1.5':'‚öΩ Under 1.5','over2.5':'‚öΩ Over 2.5','under2.5':'‚öΩ Under 2.5','over3.5':'‚öΩ Over 3.5','under3.5':'‚öΩ Under 3.5','btts':'‚öΩ BTTS'};return labels[market]||market;}
async function updateInitialBank(newBank){state.initialBank=newBank;state.currentBank=newBank;await db.collection('users').doc(currentUser.uid).update({initialBank:newBank});await loadUserCalculator();}
async function addStake(){const stakeAmount=calculateStakeAmount(state.odds,state.winProb,state.kellyType,state.currentBank);if(!state.homeTeam||!state.awayTeam){alert('–í—ä–≤–µ–¥–∏ –¥–æ–º–∞–∫–∏–Ω –∏ –≥–æ—Å—Ç!');return;}if(stakeAmount<=0){alert('–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏!');return;}const newStake={userId:currentUser.uid,number:state.stakes.length+1,homeTeam:state.homeTeam,awayTeam:state.awayTeam,market:state.market,kellyType:state.kellyType,odds:parseFloat(String(state.odds).replace(',','.')),winProb:parseFloat(String(state.winProb).replace(',','.')),stakeAmount:stakeAmount,potentialWin:stakeAmount*parseFloat(String(state.odds).replace(',','.')),potentialProfit:(stakeAmount*parseFloat(String(state.odds).replace(',','.')))-stakeAmount,result:'pending',sentToTelegram:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()};await db.collection('stakes').add(newStake);state.currentBank-=stakeAmount;state.homeTeam='';state.awayTeam='';state.odds='';state.winProb='';await loadUserCalculator();}
async function sendUnsentStakesToTelegram(){const unsentStakes=state.stakes.filter(s=>s.result==='pending'&&!s.sentToTelegram);if(unsentStakes.length===0){alert('–ù—è–º–∞ –Ω–µ–∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ –∑–∞–ª–æ–∑–∏!');return;}const kellyLabels={'half':'Half Kelly','quarter':'Quarter Kelly','full':'Full Kelly'};const telegramData=unsentStakes.map(stake=>({homeTeam:stake.homeTeam,awayTeam:stake.awayTeam,marketLabel:getMarketLabel(stake.market),odds:stake.odds.toFixed(2),kellyTypeLabel:kellyLabels[stake.kellyType],stakeAmount:stake.stakeAmount.toFixed(2),currentBank:state.currentBank.toFixed(2),potentialProfit:stake.potentialProfit.toFixed(2)}));try{const jsonString=JSON.stringify(telegramData);const encodedData=encodeURIComponent(jsonString);const callbackName='telegramCallback'+Date.now();const jsonpPromise=new Promise((resolve,reject)=>{window[callbackName]=function(response){delete window[callbackName];document.body.removeChild(script);resolve(response);};const script=document.createElement('script');script.src=`${TELEGRAM_WEBHOOK_URL}?data=${encodedData}&callback=${callbackName}`;script.onerror=()=>{delete window[callbackName];document.body.removeChild(script);reject(new Error('Failed to load script'));};document.body.appendChild(script);setTimeout(()=>{if(window[callbackName]){delete window[callbackName];document.body.removeChild(script);reject(new Error('Request timeout'));}},30000);});const result=await jsonpPromise;if(result.success){for(const stake of unsentStakes){await db.collection('stakes').doc(stake.id).update({sentToTelegram:true});}alert(`‚úÖ ${result.count} –∑–∞–ª–æ–≥–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏!`);await loadUserCalculator();}else{throw new Error(result.error||'–ì—Ä–µ—à–∫–∞');}}catch(error){console.error('Telegram error:',error);alert(`‚ùå –ì—Ä–µ—à–∫–∞: ${error.message}`);}}
async function markResult(stakeId,result){const stakeDoc=await db.collection('stakes').doc(stakeId).get();const stake=stakeDoc.data();await db.collection('stakes').doc(stakeId).update({result:result});if(result==='win'){state.currentBank+=stake.potentialWin||0;}else if(result==='push'){state.currentBank+=stake.stakeAmount||0;}await loadUserCalculator();}
async function editPendingStake(stakeId){const stakeDoc=await db.collection('stakes').doc(stakeId).get();const stake=stakeDoc.data();const modal=document.createElement('div');modal.id='editModal';modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';modal.innerHTML=`<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><h2 class="text-2xl font-bold mb-4 text-blue-600">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ó–∞–ª–æ–≥ #${stake.number}</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">üè† –î–æ–º–∞–∫–∏–Ω</label><input type="text" id="editHomeTeam" value="${stake.homeTeam}" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block text-sm font-medium mb-2">‚úàÔ∏è –ì–æ—Å—Ç</label><input type="text" id="editAwayTeam" value="${stake.awayTeam}" class="w-full p-3 border-2 rounded-lg"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">–ü–∞–∑–∞—Ä</label><select id="editMarket" class="w-full p-3 border-2 rounded-lg"><option value="home" ${stake.market==='home'?'selected':''}>üè† Home</option><option value="away" ${stake.market==='away'?'selected':''}>‚úàÔ∏è Away</option><option value="over0.5home" ${stake.market==='over0.5home'?'selected':''}>‚öΩ O0.5 Home</option><option value="over0.5away" ${stake.market==='over0.5away'?'selected':''}>‚öΩ O0.5 Away</option><option value="over1.5" ${stake.market==='over1.5'?'selected':''}>‚öΩ Over 1.5</option><option value="under1.5" ${stake.market==='under1.5'?'selected':''}>‚öΩ Under 1.5</option><option value="over2.5" ${stake.market==='over2.5'?'selected':''}>‚öΩ Over 2.5</option><option value="under2.5" ${stake.market==='under2.5'?'selected':''}>‚öΩ Under 2.5</option><option value="over3.5" ${stake.market==='over3.5'?'selected':''}>‚öΩ Over 3.5</option><option value="under3.5" ${stake.market==='under3.5'?'selected':''}>‚öΩ Under 3.5</option><option value="btts" ${stake.market==='btts'?'selected':''}>‚öΩ BTTS</option></select></div><div><label class="block text-sm font-medium mb-2">Kelly –¢–∏–ø</label><select id="editKellyType" class="w-full p-3 border-2 rounded-lg"><option value="half" ${stake.kellyType==='half'?'selected':''}>Half Kelly</option><option value="quarter" ${stake.kellyType==='quarter'?'selected':''}>Quarter Kelly</option><option value="full" ${stake.kellyType==='full'?'selected':''}>Full Kelly</option></select></div></div><div class="grid grid-cols-2 gap-4 mb-6"><div><label class="block text-sm font-medium mb-2">–ö–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç</label><input type="number" step="0.01" id="editOdds" value="${stake.odds}" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block text-sm font-medium mb-2">–í–µ—Ä–æ—è—Ç–Ω–æ—Å—Ç %</label><input type="number" step="0.1" id="editWinProb" value="${stake.winProb}" class="w-full p-3 border-2 rounded-lg"></div></div><div class="flex gap-3"><button onclick="savePendingStakeEdit('${stakeId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold">‚úÖ –ó–∞–ø–∞–∑–∏</button><button onclick="deleteStake('${stakeId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-semibold">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button><button onclick="closeEditModal()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white p-3 rounded-lg font-semibold">‚ùå –û—Ç–∫–∞–∑</button></div></div>`;document.body.appendChild(modal);}
async function editCompletedStake(stakeId){const stakeDoc=await db.collection('stakes').doc(stakeId).get();const stake=stakeDoc.data();const modal=document.createElement('div');modal.id='editModal';modal.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';modal.innerHTML=`<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><h2 class="text-2xl font-bold mb-4 text-blue-600">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π –ó–∞–≤—ä—Ä—à–µ–Ω –ó–∞–ª–æ–≥ #${stake.number}</h2><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">üè† –î–æ–º–∞–∫–∏–Ω</label><input type="text" id="editHomeTeam" value="${stake.homeTeam}" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block text-sm font-medium mb-2">‚úàÔ∏è –ì–æ—Å—Ç</label><input type="text" id="editAwayTeam" value="${stake.awayTeam}" class="w-full p-3 border-2 rounded-lg"></div></div><div class="grid grid-cols-2 gap-4 mb-4"><div><label class="block text-sm font-medium mb-2">–ü–∞–∑–∞—Ä</label><select id="editMarket" class="w-full p-3 border-2 rounded-lg"><option value="home" ${stake.market==='home'?'selected':''}>üè† Home</option><option value="away" ${stake.market==='away'?'selected':''}>‚úàÔ∏è Away</option><option value="over0.5home" ${stake.market==='over0.5home'?'selected':''}>‚öΩ O0.5 Home</option><option value="over0.5away" ${stake.market==='over0.5away'?'selected':''}>‚öΩ O0.5 Away</option><option value="over1.5" ${stake.market==='over1.5'?'selected':''}>‚öΩ Over 1.5</option><option value="under1.5" ${stake.market==='under1.5'?'selected':''}>‚öΩ Under 1.5</option><option value="over2.5" ${stake.market==='over2.5'?'selected':''}>‚öΩ Over 2.5</option><option value="under2.5" ${stake.market==='under2.5'?'selected':''}>‚öΩ Under 2.5</option><option value="over3.5" ${stake.market==='over3.5'?'selected':''}>‚öΩ Over 3.5</option><option value="under3.5" ${stake.market==='under3.5'?'selected':''}>‚öΩ Under 3.5</option><option value="btts" ${stake.market==='btts'?'selected':''}>‚öΩ BTTS</option></select></div><div><label class="block text-sm font-medium mb-2">–†–µ–∑—É–ª—Ç–∞—Ç</label><select id="editResult" class="w-full p-3 border-2 rounded-lg"><option value="pending" ${stake.result==='pending'?'selected':''}>‚è≥ Pending</option><option value="win" ${stake.result==='win'?'selected':''}>‚úÖ Win</option><option value="lose" ${stake.result==='lose'?'selected':''}>‚ùå Lose</option><option value="push" ${stake.result==='push'?'selected':''}>üîÑ Push</option></select></div></div><div class="grid grid-cols-3 gap-4 mb-6"><div><label class="block text-sm font-medium mb-2">–ö–æ–µ—Ñ–∏—Ü–∏–µ–Ω—Ç</label><input type="number" step="0.01" id="editOdds" value="${stake.odds}" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block text-sm font-medium mb-2">Kelly –¢–∏–ø</label><select id="editKellyType" class="w-full p-3 border-2 rounded-lg"><option value="half" ${stake.kellyType==='half'?'selected':''}>Half Kelly</option><option value="quarter" ${stake.kellyType==='quarter'?'selected':''}>Quarter Kelly</option><option value="full" ${stake.kellyType==='full'?'selected':''}>Full Kelly</option></select></div><div><label class="block text-sm font-medium mb-2">–°—É–º–∞ (–ª–≤)</label><input type="number" step="0.01" id="editStakeAmount" value="${stake.stakeAmount}" class="w-full p-3 border-2 rounded-lg"></div></div><div class="flex gap-3"><button onclick="saveCompletedStakeEdit('${stakeId}')" class="flex-1 bg-green-600 hover:bg-green-700 text-white p-3 rounded-lg font-semibold">‚úÖ –ó–∞–ø–∞–∑–∏</button><button onclick="deleteStake('${stakeId}')" class="flex-1 bg-red-600 hover:bg-red-700 text-white p-3 rounded-lg font-semibold">üóëÔ∏è –ò–∑—Ç—Ä–∏–π</button><button onclick="closeEditModal()" class="flex-1 bg-gray-400 hover:bg-gray-500 text-white p-3 rounded-lg font-semibold">‚ùå –û—Ç–∫–∞–∑</button></div></div>`;document.body.appendChild(modal);}
function closeEditModal(){const modal=document.getElementById('editModal');if(modal){modal.remove();}}
async function savePendingStakeEdit(stakeId){const homeTeam=document.getElementById('editHomeTeam').value;const awayTeam=document.getElementById('editAwayTeam').value;const market=document.getElementById('editMarket').value;const kellyType=document.getElementById('editKellyType').value;const odds=parseFloat(document.getElementById('editOdds').value);const winProb=parseFloat(document.getElementById('editWinProb').value);if(!homeTeam||!awayTeam||!odds||!winProb){alert('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{const stakeDoc=await db.collection('stakes').doc(stakeId).get();const oldStake=stakeDoc.data();state.currentBank+=oldStake.stakeAmount||0;const newStakeAmount=calculateStakeAmount(odds,winProb,kellyType,state.currentBank);if(newStakeAmount>state.currentBank){alert('–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–∞!');state.currentBank-=oldStake.stakeAmount||0;return;}await db.collection('stakes').doc(stakeId).update({homeTeam:homeTeam,awayTeam:awayTeam,market:market,kellyType:kellyType,odds:odds,winProb:winProb,stakeAmount:newStakeAmount,potentialWin:newStakeAmount*odds,potentialProfit:(newStakeAmount*odds)-newStakeAmount,sentToTelegram:false});state.currentBank-=newStakeAmount;closeEditModal();await loadUserCalculator();alert('‚úÖ –ó–∞–ª–æ–≥—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω!');}catch(error){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+error.message);}}
async function saveCompletedStakeEdit(stakeId){const homeTeam=document.getElementById('editHomeTeam').value;const awayTeam=document.getElementById('editAwayTeam').value;const market=document.getElementById('editMarket').value;const kellyType=document.getElementById('editKellyType').value;const odds=parseFloat(document.getElementById('editOdds').value);const stakeAmount=parseFloat(document.getElementById('editStakeAmount').value);const result=document.getElementById('editResult').value;if(!homeTeam||!awayTeam||!odds||!stakeAmount){alert('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{await db.collection('stakes').doc(stakeId).update({homeTeam:homeTeam,awayTeam:awayTeam,market:market,kellyType:kellyType,odds:odds,stakeAmount:stakeAmount,potentialWin:stakeAmount*odds,potentialProfit:(stakeAmount*odds)-stakeAmount,result:result});closeEditModal();await loadUserCalculator();alert('‚úÖ –ó–∞–ª–æ–≥—ä—Ç –µ –æ–±–Ω–æ–≤–µ–Ω!');}catch(error){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+error.message);}}
async function deleteStake(stakeId){if(!confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?'))return;try{const stakeDoc=await db.collection('stakes').doc(stakeId).get();const stake=stakeDoc.data();if(stake.result==='pending'){state.currentBank+=stake.stakeAmount||0;}await db.collection('stakes').doc(stakeId).delete();closeEditModal();alert('‚úÖ –ò–∑—Ç—Ä–∏—Ç!');await loadUserCalculator();}catch(error){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+error.message);}}
window.markResult=markResult;
window.sendUnsentStakesToTelegram=sendUnsentStakesToTelegram;
window.editPendingStake=editPendingStake;
window.editCompletedStake=editCompletedStake;
window.closeEditModal=closeEditModal;
window.savePendingStakeEdit=savePendingStakeEdit;
window.saveCompletedStakeEdit=saveCompletedStakeEdit;
window.deleteStake=deleteStake;
async function loadUserCalculator(){try{const stakesSnapshot=await db.collection('stakes').where('userId','==',currentUser.uid).get();state.stakes=[];let tempBank=state.initialBank;const stakesArray=[];stakesSnapshot.forEach(doc=>{const data=doc.data();stakesArray.push({id:doc.id,...data,timestamp:data.timestamp?.toDate?data.timestamp.toDate():new Date()});});stakesArray.sort((a,b)=>b.timestamp-a.timestamp);state.stakes=stakesArray;stakesArray.forEach(stake=>{tempBank-=stake.stakeAmount||0;if(stake.result==='win')tempBank+=stake.potentialWin||0;else if(stake.result==='push')tempBank+=stake.stakeAmount||0;});state.currentBank=tempBank;renderCalculator();}catch(error){console.error('Error:',error);renderCalculator();}}
async function loadAdminPanel(){document.getElementById('userInfo').textContent='üëë Admin Mode';document.getElementById('calculatorContent').innerHTML='<div class="bg-white p-6 rounded-xl"><h2 class="text-2xl font-bold">Admin Panel</h2></div>';}
function renderCalculator(){const pendingStakes=state.stakes.filter(s=>s&&s.result==='pending');const unsentStakes=pendingStakes.filter(s=>!s.sentToTelegram);const completedStakes=state.stakes.filter(s=>s&&s.result!=='pending');const wonStakes=completedStakes.filter(s=>s.result==='win');const lostStakes=completedStakes.filter(s=>s.result==='lose');const totalStaked=completedStakes.reduce((sum,s)=>sum+(s.stakeAmount||0),0);const totalProfit=wonStakes.reduce((sum,s)=>sum+(s.potentialProfit||0),0)-lostStakes.reduce((sum,s)=>sum+(s.stakeAmount||0),0);const yield_pct=calculateYield(totalProfit,totalStaked);const roi=calculateROI(state.currentBank||state.initialBank,state.initialBank);const winRate=completedStakes.length>0?(wonStakes.length/completedStakes.length*100):0;document.getElementById('calculatorContent').innerHTML=<div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6"><div class="bg-white rounded-xl p-5 shadow-lg"><label class="block text-sm font-medium text-gray-600 mb-2">–ù–∞—á–∞–ª–Ω–∞ –ë–∞–Ω–∫–∞</label><input type="number" id="initialBankInput" value="${state.initialBank}" class="w-full text-2xl font-bold text-blue-600 border-2 rounded-lg p-2"></div><div class="bg-white rounded-xl p-5 shadow-lg"><label class="block text-sm font-medium text-gray-600 mb-2">–¢–µ–∫—É—â–∞ –ë–∞–Ω–∫–∞</label><div class="text-3xl font-bold text-green-600">${state.currentBank.toFixed(2)} –ª–≤</div></div><div class="bg-white rounded-xl p-5 shadow-lg"><label class="block text-sm font-medium text-gray-600 mb-2">ROI</label><div class="text-3xl font-bold ${roi>=0?'text-green-600':'text-red-600'}">${roi>=0?'+':''}${roi.toFixed(2)}%</div></div><div class="bg-white rounded-xl p-5 shadow-lg"><label class="block text-sm font-medium text-gray-600 mb-2">Win Rate</label><div class="text-3xl font-bold text-blue-600">${winRate.toFixed(1)}%</div></div></div><div class="bg-white rounded-2xl shadow-xl p-6 mb-6"><h2 class="text-xl font-bold mb-4">‚ûï –î–æ–±–∞–≤–∏ –ó–∞–ª–æ–≥</h2><div class="grid grid-cols-2 gap-4 mb-4"><input type="text" id="homeTeamInput" value="${state.homeTeam}" placeholder="–î–æ–º–∞–∫–∏–Ω" class="p-3 border-2 rounded-lg"><input type="text" id="awayTeamInput" value="${state.awayTeam}" placeholder="–ì–æ—Å—Ç" class="p-3 border-2 rounded-lg"></div><div class="grid grid-cols-4 gap-4 mb-4"><select id="marketSelect" class="p-3 border-2 rounded-lg"><option value="home" ${state.market==='home'?'selected':''}>üè† Home</option><option value="away" ${state.market==='away'?'selected':''}>‚úàÔ∏è Away</option><option value="over0.5home" ${state.market==='over0.5home'?'selected':''}>‚öΩ O0.5 Home</option><option value="over0.5away" ${state.market==='over0.5away'?'selected':''}>‚öΩ O0.5 Away</option><option value="over1.5" ${state.market==='over1.5'?'selected':''}>‚öΩ Over 1.5</option><option value="under1.5" ${state.market==='under1.5'?'selected':''}>‚öΩ Under 1.5</option><option value="over2.5" ${state.market==='over2.5'?'selected':''}>‚öΩ Over 2.5</option><option value="under2.5" ${state.market==='under2.5'?'selected':''}>‚öΩ Under 2.5</option><option value="over3.5" ${state.market==='over3.5'?'selected':''}>‚öΩ Over 3.5</option><option value="under3.5" ${state.market==='under3.5'?'selected':''}>‚öΩ Under 3.5</option><option value="btts" ${state.market==='btts'?'selected':''}>‚öΩ BTTS</option></select><select id="kellyTypeSelect" class="p-3 border-2 rounded-lg"><option value="half" ${state.kellyType==='half'?'selected':''}>Half Kelly</option><option value="quarter" ${state.kellyType==='quarter'?'selected':''}>Quarter Kelly</option><option value="full" ${state.kellyType==='full'?'selected':''}>Full Kelly</option></select><input type="number" id="oddsInput" value="${state.odds}" placeholder="–ö–æ–µ—Ñ." class="p-3 border-2 rounded-lg"><input type="number" id="winProbInput" value="${state.winProb}" placeholder="%" class="p-3 border-2 rounded-lg"></div><button id="addStakeBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold">‚ûï –î–æ–±–∞–≤–∏</button></div>${pendingStakes.length>0?<div class="bg-white rounded-2xl shadow-xl p-6 mb-6"><div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold">‚è≥ –ê–∫—Ç–∏–≤–Ω–∏ (${pendingStakes.length})</h2>${unsentStakes.length>0?<button onclick="sendUnsentStakesToTelegram()" class="bg-blue-600 text-white px-4 py-2 rounded-lg">üì§ –ò–∑–ø—Ä–∞—Ç–∏ –∫—ä–º Telegram (${unsentStakes.length})</button>:''}</div>${pendingStakes.map(s=><div class="border-b p-3"><p class="font-bold">${s.homeTeam} vs ${s.awayTeam}</p><p class="text-sm text-gray-600">${getMarketLabel(s.market)} | –ó–∞–ª–æ–≥: ${s.stakeAmount.toFixed(2)} –ª–≤ | ${s.sentToTelegram?'‚úÖ':'‚è≥'}</p><div class="flex gap-2 mt-2"><button onclick="editPendingStake('${s.id}')" class="bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button><button onclick="markResult('${s.id}','win')" class="bg-green-500 hover:bg-green-600 text-white px-3 py-1 rounded text-sm">Win</button><button onclick="markResult('${s.id}','push')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-3 py-1 rounded text-sm">Push</button><button onclick="markResult('${s.id}','lose')" class="bg-red-500 hover:bg-red-600 text-white px-3 py-1 rounded text-sm">Lose</button></div></div>).join('')}</div>:''}${completedStakes.length>0?<div class="bg-white rounded-2xl shadow-xl p-6"><h2 class="text-xl font-bold mb-4">üìä –ò—Å—Ç–æ—Ä–∏—è (${completedStakes.length})</h2>${completedStakes.slice(0,20).map(s=><div class="border-b p-3 ${s.result==='win'?'bg-green-50':s.result==='lose'?'bg-red-50':'bg-yellow-50'}"><p class="font-bold">${s.homeTeam} vs ${s.awayTeam}</p><p class="text-sm text-gray-600">${getMarketLabel(s.market)} | –ó–∞–ª–æ–≥: ${s.stakeAmount.toFixed(2)} –ª–≤ | ${s.result.toUpperCase()}</p><button onclick="editCompletedStake('${s.id}')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-3 py-1 rounded text-sm">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button></div>).join('')}</div>:''};const homeInput=document.getElementById('homeTeamInput');const awayInput=document.getElementById('awayTeamInput');const marketSelect=document.getElementById('marketSelect');const kellySelect=document.getElementById('kellyTypeSelect');const oddsInput=document.getElementById('oddsInput');const probInput=document.getElementById('winProbInput');const addBtn=document.getElementById('addStakeBtn');const bankInput=document.getElementById('initialBankInput');if(homeInput)homeInput.addEventListener('input',e=>state.homeTeam=e.target.value);if(awayInput)awayInput.addEventListener('input',e=>state.awayTeam=e.target.value);if(marketSelect)marketSelect.addEventListener('change',e=>state.market=e.target.value);if(kellySelect)kellySelect.addEventListener('change',e=>state.kellyType=e.target.value);if(oddsInput)oddsInput.addEventListener('input',e=>state.odds=e.target.value);if(probInput)probInput.addEventListener('input',e=>state.winProb=e.target.value);if(addBtn)addBtn.addEventListener('click',addStake);if(bankInput)bankInput.addEventListener('change',e=>updateInitialBank(parseFloat(e.target.value)));}
document.addEventListener('DOMContentLoaded',()=>{document.getElementById('loginBtn')?.addEventListener('click',login);document.getElementById('registerBtn')?.addEventListener('click',register);document.getElementById('adminLoginBtn')?.addEventListener('click',adminLogin);document.getElementById('logoutBtn')?.addEventListener('click',logout);document.getElementById('toggleToRegisterBtn')?.addEventListener('click',toggleAuth);document.getElementById('toggleToLoginBtn')?.addEventListener('click',toggleAuth);document.getElementById('showAdminBtn')?.addEventListener('click',showAdminLogin);document.getElementById('hideAdminBtn')?.addEventListener('click',hideAdminLogin);initializeFirebase().then(()=>{console.log('Firebase –≥–æ—Ç–æ–≤, —Å–∫—Ä–∏–≤–∞–º–µ loading screen');document.getElementById('loadingScreen').style.display='none';auth.onAuthStateChanged(async(user)=>{console.log('Auth state changed:',user?'User logged in':'No user');if(user&&!isAdmin){currentUser=user;try{const userDoc=await db.collection('users').doc(user.uid).get();if(!userDoc.exists){console.error('User doc –Ω–µ —Å—ä—â–µ—Å—Ç–≤—É–≤–∞');showError('–ì—Ä–µ—à–∫–∞ –ø—Ä–∏ –∑–∞—Ä–µ–∂–¥–∞–Ω–µ –Ω–∞ –¥–∞–Ω–Ω–∏');await auth.signOut();return;}const userData=userDoc.data();state.initialBank=userData.initialBank||1000;document.getElementById('authScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');document.getElementById('userInfo').textContent=–ó–¥—Ä–∞–≤–µ–π, ${userData.username}!;await loadUserCalculator();}catch(error){console.error('Error loading user:',error);showError('–ì—Ä–µ—à–∫–∞: '+error.message);}}else if(!isAdmin){document.getElementById('loadingScreen').style.display='none';document.getElementById('authScreen').classList.remove('hidden');document.getElementById('mainApp').classList.add('hidden');}});}).catch(error=>{console.error('Firebase init failed:',error);document.getElementById('loadingScreen').style.display='none';alert('Firebase Error: '+error.message);});});
</script>
</body>
</html>
```
