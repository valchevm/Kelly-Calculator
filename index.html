<!DOCTYPE html>
<html lang="bg">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Kelly Calculator Pro</title>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
<style>
body{font-family:'Segoe UI',Tahoma,Geneva,Verdana,sans-serif;}
.pulse-animation{animation:pulse 2s cubic-bezier(0.4,0,0.6,1) infinite;}
@keyframes pulse{0%,100%{opacity:1;}50%{opacity:.5;}}
</style>
</head>
<body class="bg-gradient-to-br from-slate-50 to-blue-50 min-h-screen">
<div id="loadingScreen" class="fixed inset-0 bg-blue-600 flex items-center justify-center z-50">
<div class="text-center text-white">
<div class="text-6xl mb-4">‚öΩ</div>
<h1 class="text-3xl font-bold mb-2">Kelly Calculator Pro</h1>
<div class="pulse-animation text-xl">–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...</div>
</div>
</div>
<div id="authScreen" class="hidden min-h-screen flex items-center justify-center p-4">
<div class="bg-white rounded-2xl shadow-2xl p-8 w-full max-w-md">
<h1 class="text-3xl font-bold text-center mb-2 text-blue-600">‚öΩ Kelly Calculator Pro</h1>
<p class="text-center text-gray-500 text-sm mb-6">–ü—Ä–æ—Ñ–µ—Å–∏–æ–Ω–∞–ª–µ–Ω –∑–∞–ª–∞–≥–∞—Ç–µ–ª–µ–Ω –∫–∞–ª–∫—É–ª–∞—Ç–æ—Ä</p>
<div id="loginForm">
<h2 class="text-xl font-semibold mb-4">–í—Ö–æ–¥</h2>
<input type="email" id="loginEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="password" id="loginPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="loginBtn" class="w-full bg-blue-600 text-white p-3 rounded-lg font-semibold hover:bg-blue-700 mb-3">–í–ª–µ–∑</button>
<p class="text-center text-sm text-gray-600">–ù—è–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToRegisterBtn" class="text-blue-600 font-semibold">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button></p>
<hr class="my-4">
<button id="showAdminBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700">üëë Admin –í—Ö–æ–¥</button>
</div>
<div id="registerForm" class="hidden">
<h2 class="text-xl font-semibold mb-4">–†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è</h2>
<input type="text" id="registerUsername" placeholder="–ü–æ—Ç—Ä–µ–±–∏—Ç–µ–ª—Å–∫–æ –∏–º–µ" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="email" id="registerEmail" placeholder="Email" class="w-full p-3 border-2 rounded-lg mb-3">
<input type="password" id="registerPassword" placeholder="–ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="registerBtn" class="w-full bg-green-600 text-white p-3 rounded-lg font-semibold hover:bg-green-700 mb-3">–†–µ–≥–∏—Å—Ç—Ä–∏—Ä–∞–π —Å–µ</button>
<p class="text-center text-sm text-gray-600">–ò–º–∞—à –∞–∫–∞—É–Ω—Ç? <button id="toggleToLoginBtn" class="text-blue-600 font-semibold">–í–ª–µ–∑</button></p>
</div>
<div id="adminLoginForm" class="hidden">
<h2 class="text-xl font-semibold mb-4">üëë Admin –í—Ö–æ–¥</h2>
<input type="password" id="adminPassword" placeholder="Admin –ü–∞—Ä–æ–ª–∞" class="w-full p-3 border-2 rounded-lg mb-4">
<button id="adminLoginBtn" class="w-full bg-purple-600 text-white p-3 rounded-lg font-semibold hover:bg-purple-700 mb-3">–í–ª–µ–∑ –∫–∞—Ç–æ Admin</button>
<button id="hideAdminBtn" class="w-full bg-gray-400 text-white p-2 rounded-lg">–ù–∞–∑–∞–¥</button>
</div>
<div id="authError" class="mt-4 p-3 bg-red-100 text-red-700 rounded-lg hidden"></div>
</div>
</div>
<div id="mainApp" class="hidden p-4 max-w-7xl mx-auto">
<div class="bg-white rounded-2xl shadow-xl p-6 mb-6">
<div class="flex justify-between items-center">
<div>
<h1 class="text-3xl font-bold text-gray-800">‚öΩ Kelly Calculator Pro</h1>
<p class="text-sm text-gray-600" id="userInfo"></p>
</div>
<button id="logoutBtn" class="bg-red-500 text-white px-4 py-2 rounded-lg hover:bg-red-600">–ò–∑—Ö–æ–¥</button>
</div>
</div>
<div id="calculatorContent"></div>
</div>
<script>
const TELEGRAM_WEBHOOK_URL='https://script.google.com/macros/s/AKfycbzBkkFvbxo7_eKpfBzdg5HTb8ecIY_MYlQhIvyT5Vo_FmY87ah8iEt6BT693TJ_8fZFpw/exec';
const ADMIN_PASSWORD="Bold_9000";
let currentUser=null,isAdmin=false,auth,db,firebaseReady=false,authListenerAttached=false;
let state={initialBank:1000,currentBank:1000,stakes:[],kellyType:'half',market:'home',homeTeam:'',awayTeam:'',odds:'',winProb:''};
const firebaseConfig={apiKey:"AIzaSyD_cE6Ek3L_l7wHRkrrmswlksUb1fLEWLA",authDomain:"kelly-calculator-fbf1a.firebaseapp.com",projectId:"kelly-calculator-fbf1a",storageBucket:"kelly-calculator-fbf1a.firebasestorage.app",messagingSenderId:"707784565895",appId:"1:707784565895:web:e27104dc0ed8d8996b0422"};
function hideLoadingScreen(){const ls=document.getElementById('loadingScreen');if(ls)ls.style.display='none';}
function showAuthScreen(){hideLoadingScreen();document.getElementById('authScreen').classList.remove('hidden');document.getElementById('mainApp').classList.add('hidden');}
function showMainApp(){hideLoadingScreen();document.getElementById('authScreen').classList.add('hidden');document.getElementById('mainApp').classList.remove('hidden');}
function initializeFirebase(){return new Promise((resolve,reject)=>{let attempts=0;const maxAttempts=50;const checkFirebase=setInterval(()=>{attempts++;if(typeof firebase!=='undefined'){clearInterval(checkFirebase);try{firebase.initializeApp(firebaseConfig);auth=firebase.auth();db=firebase.firestore();firebaseReady=true;console.log('Firebase OK');resolve();}catch(e){console.error('Firebase Error:',e);hideLoadingScreen();reject(e);}}else if(attempts>=maxAttempts){clearInterval(checkFirebase);hideLoadingScreen();reject(new Error('Firebase timeout'));}},100);});}
function showError(msg){const e=document.getElementById('authError');e.textContent=msg;e.classList.remove('hidden');setTimeout(()=>e.classList.add('hidden'),5000);}
function toggleAuth(){document.getElementById('loginForm').classList.toggle('hidden');document.getElementById('registerForm').classList.toggle('hidden');}
function showAdminLogin(){document.getElementById('loginForm').classList.add('hidden');document.getElementById('adminLoginForm').classList.remove('hidden');}
function hideAdminLogin(){document.getElementById('adminLoginForm').classList.add('hidden');document.getElementById('loginForm').classList.remove('hidden');}
async function register(){if(!firebaseReady){showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');return;}const u=document.getElementById('registerUsername').value,e=document.getElementById('registerEmail').value,p=document.getElementById('registerPassword').value;if(!u||!e||!p){showError('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{const c=await auth.createUserWithEmailAndPassword(e,p);await db.collection('users').doc(c.user.uid).set({username:u,email:e,initialBank:1000,createdAt:firebase.firestore.FieldValue.serverTimestamp()});showError('‚úÖ –£—Å–ø–µ—à–Ω–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è!');}catch(err){showError('–ì—Ä–µ—à–∫–∞: '+err.message);}}
async function login(){if(!firebaseReady){showError('–ó–∞—Ä–µ–∂–¥–∞–Ω–µ...');return;}const e=document.getElementById('loginEmail').value,p=document.getElementById('loginPassword').value;if(!e||!p){showError('–í—ä–≤–µ–¥–∏ email –∏ –ø–∞—Ä–æ–ª–∞!');return;}try{await auth.signInWithEmailAndPassword(e,p);}catch(err){showError('–ì—Ä–µ—à–∫–∞: '+err.message);}}
function adminLogin(){const p=document.getElementById('adminPassword').value;if(p===ADMIN_PASSWORD){isAdmin=true;showMainApp();loadAdminPanel();}else{showError('–ì—Ä–µ—à–Ω–∞ –ø–∞—Ä–æ–ª–∞!');}}
function logout(){isAdmin?location.reload():auth.signOut();}
function calculateStakeAmount(o,w,k,b){const p=parseFloat(String(w).replace(',','.'))/100,od=parseFloat(String(o).replace(',','.'));if(!p||!od||p<=0||p>=1||od<=1)return 0;const q=1-p,kf=(p*od-q)/od,m=k==='half'?0.5:k==='quarter'?0.25:1;return Math.max(0,b*kf*m);}
function calculateEdge(o,w){const p=parseFloat(String(w).replace(',','.'))/100,od=parseFloat(String(o).replace(',','.'));if(!p||!od||p<=0||p>=1||od<=1)return null;const ev=(p*od)-1;return{hasValue:ev>0,edgePercent:ev*100};}
function calculateYield(pr,ts){return ts===0?0:(pr/ts)*100;}
function calculateROI(c,i){return i===0?0:((c-i)/i)*100;}
function getMarketLabel(m){const l={'home':'üè† Home','away':'‚úàÔ∏è Away','over0.5home':'‚öΩ O0.5 Home','over0.5away':'‚öΩ O0.5 Away','over1.5':'‚öΩ Over 1.5','under1.5':'‚öΩ Under 1.5','over2.5':'‚öΩ Over 2.5','under2.5':'‚öΩ Under 2.5','over3.5':'‚öΩ Over 3.5','under3.5':'‚öΩ Under 3.5','btts':'‚öΩ BTTS'};return l[m]||m;}
async function updateInitialBank(n){state.initialBank=n;state.currentBank=n;await db.collection('users').doc(currentUser.uid).update({initialBank:n});await loadUserCalculator();}
async function addStake(){const sa=calculateStakeAmount(state.odds,state.winProb,state.kellyType,state.currentBank);if(!state.homeTeam||!state.awayTeam){alert('–í—ä–≤–µ–¥–∏ –¥–æ–º–∞–∫–∏–Ω –∏ –≥–æ—Å—Ç!');return;}if(sa<=0){alert('–ù–µ–≤–∞–ª–∏–¥–Ω–∏ –¥–∞–Ω–Ω–∏!');return;}const ns={userId:currentUser.uid,number:state.stakes.length+1,homeTeam:state.homeTeam,awayTeam:state.awayTeam,market:state.market,kellyType:state.kellyType,odds:parseFloat(String(state.odds).replace(',','.')),winProb:parseFloat(String(state.winProb).replace(',','.')),stakeAmount:sa,potentialWin:sa*parseFloat(String(state.odds).replace(',','.')),potentialProfit:(sa*parseFloat(String(state.odds).replace(',','.')))-sa,result:'pending',sentToTelegram:false,timestamp:firebase.firestore.FieldValue.serverTimestamp()};await db.collection('stakes').add(ns);state.currentBank-=sa;state.homeTeam='';state.awayTeam='';state.odds='';state.winProb='';await loadUserCalculator();}
// –ü–†–û–î–™–õ–ñ–ê–í–ê –í –ß–ê–°–¢ 2...// –ß–ê–°–¢ 2 - –ü–†–û–î–™–õ–ñ–ï–ù–ò–ï –ù–ê JAVASCRIPT
async function sendUnsentStakesToTelegram(){const us=state.stakes.filter(s=>s.result==='pending'&&!s.sentToTelegram);if(us.length===0){alert('–ù—è–º–∞ –Ω–µ–∏–∑–ø—Ä–∞—Ç–µ–Ω–∏ –∑–∞–ª–æ–∑–∏!');return;}const kl={'half':'Half Kelly','quarter':'Quarter Kelly','full':'Full Kelly'};const td=us.map(s=>({homeTeam:s.homeTeam,awayTeam:s.awayTeam,marketLabel:getMarketLabel(s.market),odds:s.odds.toFixed(2),kellyTypeLabel:kl[s.kellyType],stakeAmount:s.stakeAmount.toFixed(2),currentBank:state.currentBank.toFixed(2),potentialProfit:s.potentialProfit.toFixed(2)}));try{const js=JSON.stringify(td),ed=encodeURIComponent(js),cn='telegramCallback'+Date.now();const jp=new Promise((res,rej)=>{window[cn]=function(r){delete window[cn];document.body.removeChild(sc);res(r);};const sc=document.createElement('script');sc.src=TELEGRAM_WEBHOOK_URL+'?data='+ed+'&callback='+cn;sc.onerror=()=>{delete window[cn];document.body.removeChild(sc);rej(new Error('Failed'));};document.body.appendChild(sc);setTimeout(()=>{if(window[cn]){delete window[cn];document.body.removeChild(sc);rej(new Error('Timeout'));}},30000);});const r=await jp;if(r.success){for(const s of us){await db.collection('stakes').doc(s.id).update({sentToTelegram:true});}alert('‚úÖ '+r.count+' –∑–∞–ª–æ–≥–∞ –∏–∑–ø—Ä–∞—Ç–µ–Ω–∏!');await loadUserCalculator();}else{throw new Error(r.error||'–ì—Ä–µ—à–∫–∞');}}catch(e){console.error('Telegram error:',e);alert('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}}
async function markResult(sid,res){const sd=await db.collection('stakes').doc(sid).get(),s=sd.data();await db.collection('stakes').doc(sid).update({result:res});if(res==='win')state.currentBank+=s.potentialWin||0;else if(res==='push')state.currentBank+=s.stakeAmount||0;await loadUserCalculator();}
async function editPendingStake(sid){const sd=await db.collection('stakes').doc(sid).get(),s=sd.data();const m=document.createElement('div');m.id='editModal';m.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';m.innerHTML='<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><h2 class="text-2xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π #'+s.number+'</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label class="block mb-2">–î–æ–º–∞–∫–∏–Ω</label><input type="text" id="editHomeTeam" value="'+s.homeTeam+'" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block mb-2">–ì–æ—Å—Ç</label><input type="text" id="editAwayTeam" value="'+s.awayTeam+'" class="w-full p-3 border-2 rounded-lg"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label class="block mb-2">–ü–∞–∑–∞—Ä</label><select id="editMarket" class="w-full p-3 border-2 rounded-lg"><option value="home">Home</option><option value="away">Away</option><option value="over0.5home">O0.5 Home</option><option value="over0.5away">O0.5 Away</option><option value="over1.5">Over 1.5</option><option value="under1.5">Under 1.5</option><option value="over2.5">Over 2.5</option><option value="under2.5">Under 2.5</option><option value="over3.5">Over 3.5</option><option value="under3.5">Under 3.5</option><option value="btts">BTTS</option></select></div><div><label class="block mb-2">Kelly</label><select id="editKellyType" class="w-full p-3 border-2 rounded-lg"><option value="half">Half</option><option value="quarter">Quarter</option><option value="full">Full</option></select></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-6"><div><label class="block mb-2">–ö–æ–µ—Ñ.</label><input type="number" step="0.01" id="editOdds" value="'+s.odds+'" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block mb-2">%</label><input type="number" step="0.1" id="editWinProb" value="'+s.winProb+'" class="w-full p-3 border-2 rounded-lg"></div></div><div class="flex flex-col sm:flex-row gap-3"><button onclick="savePendingStakeEdit(\''+sid+'\')" class="flex-1 bg-green-600 text-white p-3 rounded-lg">–ó–∞–ø–∞–∑–∏</button><button onclick="deleteStake(\''+sid+'\')" class="flex-1 bg-red-600 text-white p-3 rounded-lg">–ò–∑—Ç—Ä–∏–π</button><button onclick="closeEditModal()" class="flex-1 bg-gray-400 text-white p-3 rounded-lg">–û—Ç–∫–∞–∑</button></div></div>';document.body.appendChild(m);document.getElementById('editMarket').value=s.market;document.getElementById('editKellyType').value=s.kellyType;}
async function editCompletedStake(sid){const sd=await db.collection('stakes').doc(sid).get(),s=sd.data();const m=document.createElement('div');m.id='editModal';m.className='fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4';m.innerHTML='<div class="bg-white rounded-2xl shadow-2xl p-6 w-full max-w-2xl max-h-[90vh] overflow-y-auto"><h2 class="text-2xl font-bold mb-4">–†–µ–¥–∞–∫—Ç–∏—Ä–∞–π #'+s.number+'</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label class="block mb-2">–î–æ–º–∞–∫–∏–Ω</label><input type="text" id="editHomeTeam" value="'+s.homeTeam+'" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block mb-2">–ì–æ—Å—Ç</label><input type="text" id="editAwayTeam" value="'+s.awayTeam+'" class="w-full p-3 border-2 rounded-lg"></div></div><div class="grid grid-cols-1 sm:grid-cols-2 gap-4 mb-4"><div><label class="block mb-2">–ü–∞–∑–∞—Ä</label><select id="editMarket" class="w-full p-3 border-2 rounded-lg"><option value="home">Home</option><option value="away">Away</option><option value="over0.5home">O0.5 Home</option><option value="over0.5away">O0.5 Away</option><option value="over1.5">Over 1.5</option><option value="under1.5">Under 1.5</option><option value="over2.5">Over 2.5</option><option value="under2.5">Under 2.5</option><option value="over3.5">Over 3.5</option><option value="under3.5">Under 3.5</option><option value="btts">BTTS</option></select></div><div><label class="block mb-2">–†–µ–∑—É–ª—Ç–∞—Ç</label><select id="editResult" class="w-full p-3 border-2 rounded-lg"><option value="pending">Pending</option><option value="win">Win</option><option value="lose">Lose</option><option value="push">Push</option></select></div></div><div class="grid grid-cols-1 sm:grid-cols-3 gap-4 mb-6"><div><label class="block mb-2">–ö–æ–µ—Ñ.</label><input type="number" step="0.01" id="editOdds" value="'+s.odds+'" class="w-full p-3 border-2 rounded-lg"></div><div><label class="block mb-2">Kelly</label><select id="editKellyType" class="w-full p-3 border-2 rounded-lg"><option value="half">Half</option><option value="quarter">Quarter</option><option value="full">Full</option></select></div><div><label class="block mb-2">–°—É–º–∞</label><input type="number" step="0.01" id="editStakeAmount" value="'+s.stakeAmount+'" class="w-full p-3 border-2 rounded-lg"></div></div><div class="flex flex-col sm:flex-row gap-3"><button onclick="saveCompletedStakeEdit(\''+sid+'\')" class="flex-1 bg-green-600 text-white p-3 rounded-lg">–ó–∞–ø–∞–∑–∏</button><button onclick="deleteStake(\''+sid+'\')" class="flex-1 bg-red-600 text-white p-3 rounded-lg">–ò–∑—Ç—Ä–∏–π</button><button onclick="closeEditModal()" class="flex-1 bg-gray-400 text-white p-3 rounded-lg">–û—Ç–∫–∞–∑</button></div></div>';document.body.appendChild(m);document.getElementById('editMarket').value=s.market;document.getElementById('editResult').value=s.result;document.getElementById('editKellyType').value=s.kellyType;}
function closeEditModal(){const m=document.getElementById('editModal');if(m)m.remove();}
async function savePendingStakeEdit(sid){const h=document.getElementById('editHomeTeam').value,a=document.getElementById('editAwayTeam').value,mk=document.getElementById('editMarket').value,kt=document.getElementById('editKellyType').value,od=parseFloat(document.getElementById('editOdds').value),wp=parseFloat(document.getElementById('editWinProb').value);if(!h||!a||!od||!wp){alert('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{const sd=await db.collection('stakes').doc(sid).get(),os=sd.data();state.currentBank+=os.stakeAmount||0;const nsa=calculateStakeAmount(od,wp,kt,state.currentBank);if(nsa>state.currentBank){alert('–ù–µ–¥–æ—Å—Ç–∞—Ç—ä—á–Ω–æ —Å—Ä–µ–¥—Å—Ç–≤–∞!');state.currentBank-=os.stakeAmount||0;return;}await db.collection('stakes').doc(sid).update({homeTeam:h,awayTeam:a,market:mk,kellyType:kt,odds:od,winProb:wp,stakeAmount:nsa,potentialWin:nsa*od,potentialProfit:(nsa*od)-nsa,sentToTelegram:false});state.currentBank-=nsa;closeEditModal();await loadUserCalculator();alert('‚úÖ –û–±–Ω–æ–≤–µ–Ω!');}catch(e){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}}
async function saveCompletedStakeEdit(sid){const h=document.getElementById('editHomeTeam').value,a=document.getElementById('editAwayTeam').value,mk=document.getElementById('editMarket').value,kt=document.getElementById('editKellyType').value,od=parseFloat(document.getElementById('editOdds').value),sa=parseFloat(document.getElementById('editStakeAmount').value),r=document.getElementById('editResult').value;if(!h||!a||!od||!sa){alert('–ü–æ–ø—ä–ª–Ω–∏ –≤—Å–∏—á–∫–∏ –ø–æ–ª–µ—Ç–∞!');return;}try{await db.collection('stakes').doc(sid).update({homeTeam:h,awayTeam:a,market:mk,kellyType:kt,odds:od,stakeAmount:sa,potentialWin:sa*od,potentialProfit:(sa*od)-sa,result:r});closeEditModal();await loadUserCalculator();alert('‚úÖ –û–±–Ω–æ–≤–µ–Ω!');}catch(e){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}}
async function deleteStake(sid){if(!confirm('–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?'))return;try{const sd=await db.collection('stakes').doc(sid).get(),s=sd.data();if(s.result==='pending')state.currentBank+=s.stakeAmount||0;await db.collection('stakes').doc(sid).delete();closeEditModal();alert('‚úÖ –ò–∑—Ç—Ä–∏—Ç!');await loadUserCalculator();}catch(e){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}}
async function resetBank(){if(!confirm('‚ö†Ô∏è –í–ù–ò–ú–ê–ù–ò–ï!\n\n–¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –í–°–ò–ß–ö–ò –∑–∞–ª–æ–∑–∏ –∏ —â–µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞ –±–∞–Ω–∫–∞—Ç–∞.\n\n–°–∏–≥—É—Ä–µ–Ω –ª–∏ —Å–∏?'))return;if(!confirm('–ù–∞–∏—Å—Ç–∏–Ω–∞ –ª–∏ –∏—Å–∫–∞—à –¥–∞ –∏–∑—Ç—Ä–∏–µ—à –≤—Å–∏—á–∫–∏ '+state.stakes.length+' –∑–∞–ª–æ–≥–∞?'))return;try{const batch=db.batch();const stakesSnapshot=await db.collection('stakes').where('userId','==',currentUser.uid).get();stakesSnapshot.forEach(doc=>{batch.delete(doc.ref);});await batch.commit();state.stakes=[];state.currentBank=state.initialBank;alert('‚úÖ –ë–∞–Ω–∫–∞—Ç–∞ –µ —Ä–µ—Å—Ç–∞—Ä—Ç–∏—Ä–∞–Ω–∞ —É—Å–ø–µ—à–Ω–æ!');await loadUserCalculator();}catch(e){alert('‚ùå –ì—Ä–µ—à–∫–∞: '+e.message);}}
window.resetBank=resetBank;
window.markResult=markResult;
window.sendUnsentStakesToTelegram=sendUnsentStakesToTelegram;
window.editPendingStake=editPendingStake;
window.editCompletedStake=editCompletedStake;
window.closeEditModal=closeEditModal;
window.savePendingStakeEdit=savePendingStakeEdit;
window.saveCompletedStakeEdit=saveCompletedStakeEdit;
window.deleteStake=deleteStake;
async function loadUserCalculator(){try{const ss=await db.collection('stakes').where('userId','==',currentUser.uid).get();state.stakes=[];let tb=state.initialBank;const sa=[];ss.forEach(d=>{const dt=d.data();sa.push({id:d.id,...dt,timestamp:dt.timestamp?.toDate?dt.timestamp.toDate():new Date()});});sa.sort((a,b)=>b.timestamp-a.timestamp);state.stakes=sa;sa.forEach(s=>{tb-=s.stakeAmount||0;if(s.result==='win')tb+=s.potentialWin||0;else if(s.result==='push')tb+=s.stakeAmount||0;});state.currentBank=tb;renderCalculator();}catch(e){console.error('Error:',e);renderCalculator();}}
async function loadAdminPanel(){document.getElementById('userInfo').textContent='üëë Admin Mode';document.getElementById('calculatorContent').innerHTML='<div class="bg-white p-6 rounded-xl"><h2 class="text-2xl font-bold">Admin Panel</h2></div>';}
function renderCalculator(){const ps=state.stakes.filter(s=>s&&s.result==='pending'),us=ps.filter(s=>!s.sentToTelegram),cs=state.stakes.filter(s=>s&&s.result!=='pending'),ws=cs.filter(s=>s.result==='win'),ls=cs.filter(s=>s.result==='lose'),ts=cs.reduce((sum,s)=>sum+(s.stakeAmount||0),0),tp=ws.reduce((sum,s)=>sum+(s.potentialProfit||0),0)-ls.reduce((sum,s)=>sum+(s.stakeAmount||0),0),yp=calculateYield(tp,ts),roi=calculateROI(state.currentBank||state.initialBank,state.initialBank),wr=cs.length>0?(ws.length/cs.length*100):0;let html='<div class="grid grid-cols-2 lg:grid-cols-4 gap-3 mb-4"><div class="bg-white rounded-xl p-4 shadow-lg"><label class="block text-xs sm:text-sm mb-1">–ù–∞—á–∞–ª–Ω–∞ –ë–∞–Ω–∫–∞</label><input type="number" id="initialBankInput" value="'+state.initialBank+'" class="w-full text-xl sm:text-2xl font-bold text-blue-600 border-2 rounded-lg p-2"></div><div class="bg-white rounded-xl p-4 shadow-lg"><label class="block text-xs sm:text-sm mb-1">–¢–µ–∫—É—â–∞ –ë–∞–Ω–∫–∞</label><div class="text-xl sm:text-3xl font-bold text-green-600">'+state.currentBank.toFixed(2)+'</div></div><div class="bg-white rounded-xl p-4 shadow-lg"><label class="block text-xs sm:text-sm mb-1">ROI</label><div class="text-xl sm:text-3xl font-bold '+(roi>=0?'text-green-600':'text-red-600')+'">'+(roi>=0?'+':'')+roi.toFixed(2)+'%</div></div><div class="bg-white rounded-xl p-4 shadow-lg"><label class="block text-xs sm:text-sm mb-1">Win Rate</label><div class="text-xl sm:text-3xl font-bold text-blue-600">'+wr.toFixed(1)+'%</div></div></div><div class="bg-gradient-to-r from-red-500 to-orange-500 rounded-xl p-4 mb-4 shadow-xl"><button onclick="resetBank()" class="w-full bg-white hover:bg-gray-100 text-red-600 font-bold py-3 px-4 rounded-lg transition transform hover:scale-105">üîÑ –†–ï–°–¢–ê–†–¢–ò–†–ê–ô –ë–ê–ù–ö–ê–¢–ê</button><p class="text-white text-xs text-center mt-2">‚ö†Ô∏è –¢–æ–≤–∞ —â–µ –∏–∑—Ç—Ä–∏–µ –≤—Å–∏—á–∫–∏ –∑–∞–ª–æ–∑–∏ –∏ —â–µ –∑–∞–ø–æ—á–Ω–µ –æ—Ç–Ω–∞—á–∞–ª–æ</p></div><div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-4"><h2 class="text-lg sm:text-xl font-bold mb-3">‚ûï –î–æ–±–∞–≤–∏ –ó–∞–ª–æ–≥</h2><div class="grid grid-cols-1 sm:grid-cols-2 gap-3 mb-3"><input type="text" id="homeTeamInput" value="'+state.homeTeam+'" placeholder="–î–æ–º–∞–∫–∏–Ω" class="p-3 border-2 rounded-lg text-sm sm:text-base"><input type="text" id="awayTeamInput" value="'+state.awayTeam+'" placeholder="–ì–æ—Å—Ç" class="p-3 border-2 rounded-lg text-sm sm:text-base"></div><div class="grid grid-cols-2 sm:grid-cols-4 gap-2 sm:gap-3 mb-3"><select id="marketSelect" class="p-2 sm:p-3 border-2 rounded-lg text-xs sm:text-base"><option value="home">Home</option><option value="away">Away</option><option value="over0.5home">O0.5 Home</option><option value="over0.5away">O0.5 Away</option><option value="over1.5">O1.5</option><option value="under1.5">U1.5</option><option value="over2.5">O2.5</option><option value="under2.5">U2.5</option><option value="over3.5">O3.5</option><option value="under3.5">U3.5</option><option value="btts">BTTS</option></select><select id="kellyTypeSelect" class="p-2 sm:p-3 border-2 rounded-lg text-xs sm:text-base"><option value="half">Half</option><option value="quarter">Quarter</option><option value="full">Full</option></select><input type="number" id="oddsInput" value="'+state.odds+'" placeholder="–ö–æ–µ—Ñ." class="p-2 sm:p-3 border-2 rounded-lg text-xs sm:text-base"><input type="number" id="winProbInput" value="'+state.winProb+'" placeholder="%" class="p-2 sm:p-3 border-2 rounded-lg text-xs sm:text-base"></div><button id="addStakeBtn" class="w-full bg-blue-600 hover:bg-blue-700 text-white p-3 rounded-lg font-semibold text-sm sm:text-base">‚ûï –î–æ–±–∞–≤–∏</button></div>';if(ps.length>0){html+='<div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6 mb-4"><div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-3 mb-4"><h2 class="text-lg sm:text-xl font-bold">‚è≥ –ê–∫—Ç–∏–≤–Ω–∏ ('+ps.length+')</h2>';if(us.length>0)html+='<button onclick="sendUnsentStakesToTelegram()" class="w-full sm:w-auto bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg text-sm sm:text-base whitespace-nowrap">üì§ –ò–∑–ø—Ä–∞—Ç–∏ ('+us.length+')</button>';html+='</div>';ps.forEach(s=>{html+='<div class="border-b p-3 mb-2"><p class="font-bold text-sm sm:text-base">'+s.homeTeam+' vs '+s.awayTeam+'</p><p class="text-xs sm:text-sm text-gray-600">'+getMarketLabel(s.market)+' | '+s.stakeAmount.toFixed(2)+' –ª–≤ | '+(s.sentToTelegram?'‚úÖ':'‚è≥')+'</p><div class="flex flex-wrap gap-1 sm:gap-2 mt-2"><button onclick="editPendingStake(\''+s.id+'\')" class="bg-blue-500 hover:bg-blue-600 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm">‚öôÔ∏è</button><button onclick="markResult(\''+s.id+'\',\'win\')" class="bg-green-500 hover:bg-green-600 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm">Win</button><button onclick="markResult(\''+s.id+'\',\'push\')" class="bg-yellow-500 hover:bg-yellow-600 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm">Push</button><button onclick="markResult(\''+s.id+'\',\'lose\')" class="bg-red-500 hover:bg-red-600 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm">Lose</button></div></div>';});html+='</div>';}if(cs.length>0){html+='<div class="bg-white rounded-2xl shadow-xl p-4 sm:p-6"><h2 class="text-lg sm:text-xl font-bold mb-4">üìä –ò—Å—Ç–æ—Ä–∏—è ('+cs.length+')</h2>';cs.slice(0,20).forEach(s=>{html+='<div class="border-b p-3 mb-2 '+(s.result==='win'?'bg-green-50':s.result==='lose'?'bg-red-50':'bg-yellow-50')+'"><p class="font-bold text-sm sm:text-base">'+s.homeTeam+' vs '+s.awayTeam+'</p><p class="text-xs sm:text-sm text-gray-600">'+getMarketLabel(s.market)+' | '+s.stakeAmount.toFixed(2)+' –ª–≤ | '+s.result.toUpperCase()+'</p><button onclick="editCompletedStake(\''+s.id+'\')" class="mt-2 bg-blue-500 hover:bg-blue-600 text-white px-2 sm:px-3 py-1 rounded text-xs sm:text-sm">‚öôÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–∞–π</button></div>';});html+='</div>';}document.getElementById('calculatorContent').innerHTML=html;const hi=document.getElementById('homeTeamInput'),ai=document.getElementById('awayTeamInput'),ms=document.getElementById('marketSelect'),ks=document.getElementById('kellyTypeSelect'),oi=document.getElementById('oddsInput'),pi=document.getElementById('winProbInput'),ab=document.getElementById('addStakeBtn'),bi=document.getElementById('initialBankInput');if(hi)hi.addEventListener('input',e=>state.homeTeam=e.target.value);if(ai)ai.addEventListener('input',e=>state.awayTeam=e.target.value);if(ms){ms.value=state.market;ms.addEventListener('change',e=>state.market=e.target.value);}if(ks){ks.value=state.kellyType;ks.addEventListener('change',e=>state.kellyType=e.target.value);}if(oi)oi.addEventListener('input',e=>state.odds=e.target.value);if(pi)pi.addEventListener('input',e=>state.winProb=e.target.value);if(ab)ab.addEventListener('click',addStake);if(bi)bi.addEventListener('change',e=>updateInitialBank(parseFloat(e.target.value)));}
document.addEventListener('DOMContentLoaded',()=>{document.getElementById('loginBtn')?.addEventListener('click',login);document.getElementById('registerBtn')?.addEventListener('click',register);document.getElementById('adminLoginBtn')?.addEventListener('click',adminLogin);document.getElementById('logoutBtn')?.addEventListener('click',logout);document.getElementById('toggleToRegisterBtn')?.addEventListener('click',toggleAuth);document.getElementById('toggleToLoginBtn')?.addEventListener('click',toggleAuth);document.getElementById('showAdminBtn')?.addEventListener('click',showAdminLogin);document.getElementById('hideAdminBtn')?.addEventListener('click',hideAdminLogin);setTimeout(()=>{if(document.getElementById('loadingScreen').style.display!=='none'){console.warn('FORCE —Å–∫—Ä–∏–≤–∞–Ω–µ');hideLoadingScreen();showAuthScreen();}},5000);initializeFirebase().then(()=>{console.log('Firebase –≥–æ—Ç–æ–≤');hideLoadingScreen();if(!authListenerAttached){authListenerAttached=true;auth.onAuthStateChanged(async(user)=>{console.log('Auth:',user?user.email:'No user');if(user&&!isAdmin){currentUser=user;try{const ud=await db.collection('users').doc(user.uid).get();if(!ud.exists){console.error('User doc –ª–∏–ø—Å–≤–∞');showError('–ì—Ä–µ—à–∫–∞');await auth.signOut();return;}const udata=ud.data();state.initialBank=udata.initialBank||1000;showMainApp();document.getElementById('userInfo').textContent='–ó–¥—Ä–∞–≤–µ–π, '+udata.username+'!';await loadUserCalculator();}catch(e){console.error('Error:',e);showError('–ì—Ä–µ—à–∫–∞: '+e.message);}}else if(!isAdmin){showAuthScreen();}});}}).catch(e=>{console.error('Firebase init failed:',e);hideLoadingScreen();showAuthScreen();alert('Firebase Error: '+e.message);});});
// –ö–†–ê–ô –ù–ê JAVASCRIPT - –ó–ê–¢–í–û–†–ò –°–™–°: </script></body></html>
